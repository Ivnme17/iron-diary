---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="DiarioDeHierro - Editar Entrenamiento">
	<div class="min-h-screen bg-gray-900 py-8">
		<div class="max-w-2xl mx-auto">
			<h1 class="text-4xl font-bold mb-8 text-primary-500">Editar Entrenamiento</h1>
			
			<form id="workoutForm" class="space-y-8 bg-gray-800 p-8 rounded-xl shadow-2xl border border-gray-700">
				<div>
					<label for="name" class="block text-sm font-medium text-gray-300 mb-2">Nombre del Entrenamiento</label>
					<input type="text" id="name" name="name" required 
						class="mt-1 block w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-gray-100">
				</div>
				
				<div>
					<label for="date" class="block text-sm font-medium text-gray-300 mb-2">Fecha</label>
					<input type="date" id="date" name="date" required 
						class="mt-1 block w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-gray-100">
				</div>
				
				<div>
					<div class="flex justify-between items-center mb-6">
						<h3 class="text-xl font-semibold text-gray-200">Ejercicios</h3>
						<button type="button" onclick="addExercise()" 
							class="bg-primary-600 text-white px-4 py-2 rounded-lg hover:bg-primary-700 transition-colors">
							Añadir Ejercicio
						</button>
					</div>
					
					<div id="exercisesList" class="space-y-6">
						<!-- Los ejercicios se cargarán aquí dinámicamente -->
					</div>
				</div>
				
				<div class="flex space-x-4 pt-6">
					<button type="submit" 
						class="bg-primary-600 text-white px-8 py-3 rounded-lg hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 focus:ring-offset-gray-800 transition-colors font-semibold">
						Guardar Cambios
					</button>
					<a href="/dashboard" 
						class="bg-gray-700 text-white px-8 py-3 rounded-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-800 transition-colors font-semibold">
						Cancelar
					</a>
				</div>
			</form>
		</div>
	</div>

	<script>
		let workoutData = null;
		let exerciseCount = 0;
		
		async function loadWorkout() {
			const token = localStorage.getItem('token');
			const urlParams = new URLSearchParams(window.location.search);
			const workoutId = urlParams.get('id') || window.location.pathname.split('/').pop();
			
			if (!token) {
				window.location.href = '/auth';
				return;
			}
			
			try {
				const response = await fetch(`/api/workouts/${workoutId}`, {
					headers: {
						'Authorization': `Bearer ${token}`
					}
				});
				
				if (response.ok) {
					workoutData = await response.json();
					populateForm();
				} else if (response.status === 401) {
					localStorage.removeItem('token');
					window.location.href = '/auth';
				} else {
					console.error('Error loading workout');
					window.location.href = '/dashboard';
				}
			} catch (error) {
				console.error('Error:', error);
				window.location.href = '/dashboard';
			}
		}
		
		function populateForm() {
			if (!workoutData) return;
			
			document.getElementById('name').value = workoutData.name;
			document.getElementById('date').value = new Date(workoutData.date).toISOString().split('T')[0];
			
			const exercisesList = document.getElementById('exercisesList');
			exercisesList.innerHTML = '';
			
			workoutData.exercises.forEach(exercise => {
				addExercise(exercise);
			});
		}
		
		function addExercise(exerciseData = null) {
			exerciseCount++;
			const exercisesList = document.getElementById('exercisesList');
			
			const exerciseDiv = document.createElement('div');
			exerciseDiv.className = 'bg-gray-700 p-4 rounded-lg space-y-3 border border-gray-600';
			exerciseDiv.innerHTML = `
				<div class="flex justify-between items-center">
					<h4 class="font-medium text-gray-200">Ejercicio ${exerciseCount}</h4>
					<button type="button" onclick="removeExercise(this)" 
						class="text-red-500 hover:text-red-400 transition-colors">
						Eliminar
					</button>
				</div>
				<div class="grid grid-cols-2 gap-3">
					<div>
						<label class="block text-sm font-medium text-gray-300">Nombre</label>
						<input type="text" name="exercise_name_${exerciseCount}" required 
							value="${exerciseData ? exerciseData.name : ''}"
							class="mt-1 block w-full px-3 py-2 bg-gray-600 border border-gray-500 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-gray-100">
					</div>
					<div>
						<label class="block text-sm font-medium text-gray-300 mb-2">Peso (kg)</label>
						<div class="flex items-center space-x-2">
							<input type="number" step="0.5" name="exercise_weight_${exerciseCount}" required 
								value="${exerciseData ? exerciseData.weight : ''}"
								class="flex-1 mt-1 block px-3 py-2 bg-gray-600 border border-gray-500 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-gray-100">
							<div class="flex flex-col space-y-1">
								<button type="button" onclick="adjustWeight(${exerciseCount}, -2.5)" 
									class="bg-gray-600 text-white px-3 py-2 rounded hover:bg-gray-700 text-sm font-medium transition-colors"
									title="Reducir 2.5 kg">
									- 2.5 kg
								</button>
								<button type="button" onclick="adjustWeight(${exerciseCount}, 2.5)" 
									class="bg-primary-600 text-white px-3 py-2 rounded hover:bg-primary-700 text-sm font-medium transition-colors"
									title="Aumentar 2.5 kg">
									+ 2.5 kg
								</button>
							</div>
						</div>
					</div>
					<div>
						<label class="block text-sm font-medium text-gray-300">Series</label>
						<input type="number" name="exercise_sets_${exerciseCount}" required 
							value="${exerciseData ? exerciseData.sets : ''}"
							class="mt-1 block w-full px-3 py-2 bg-gray-600 border border-gray-500 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-gray-100">
					</div>
					<div>
						<label class="block text-sm font-medium text-gray-300">Repeticiones</label>
						<input type="number" name="exercise_reps_${exerciseCount}" required 
							value="${exerciseData ? exerciseData.reps : ''}"
							class="mt-1 block w-full px-3 py-2 bg-gray-600 border border-gray-500 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-gray-100">
					</div>
				</div>
			`;
			
			exercisesList.appendChild(exerciseDiv);
		}
		
		function adjustWeight(exerciseId, delta) {
			const weightInput = document.querySelector(`input[name="exercise_weight_${exerciseId}"]`);
			if (weightInput) {
				const currentValue = parseFloat(weightInput.value) || 0;
				const newValue = Math.max(0, currentValue + delta);
				weightInput.value = newValue.toFixed(1);
				// Disparar evento change para que se actualicen otros componentes si es necesario
				weightInput.dispatchEvent(new Event('input', { bubbles: true }));
			}
		}
		
		function removeExercise(button) {
			button.closest('.bg-gray-700').remove();
		}
		
		async function saveWorkout(e) {
			e.preventDefault();
			
			const token = localStorage.getItem('token');
			const workoutId = window.location.pathname.split('/').pop();
			
			const formData = new FormData(e.target);
			const exercises = [];
			
			// Recopilar ejercicios
			for (let i = 1; i <= exerciseCount; i++) {
				const name = formData.get(`exercise_name_${i}`);
				const weight = formData.get(`exercise_weight_${i}`);
				const sets = formData.get(`exercise_sets_${i}`);
				const reps = formData.get(`exercise_reps_${i}`);
				
				if (name && weight && sets && reps) {
					exercises.push({
						name,
						weight: parseFloat(weight || '0'),
						sets: parseInt(sets || '0'),
						reps: parseInt(reps || '0')
					});
				}
			}
			
			const workoutData = {
				name: formData.get('name'),
				date: new Date(formData.get('date') || '').toISOString(),
				exercises
			};
			
			try {
				const response = await fetch(`/api/workouts/${workoutId}`, {
					method: 'PUT',
					headers: {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${token}`
					},
					body: JSON.stringify(workoutData)
				});
				
				if (response.ok) {
					window.location.href = '/dashboard';
				} else {
					const error = await response.json();
					alert('Error al guardar: ' + error.detail);
				}
			} catch (error) {
				console.error('Error:', error);
				alert('Error de conexión');
			}
		}
		
		document.getElementById('workoutForm').addEventListener('submit', saveWorkout);
		
		// Cargar datos del entrenamiento al iniciar
		loadWorkout();
	</script>
</Layout>
